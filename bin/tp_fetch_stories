#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"

require_relative "../lib/tp_to_github"

team_name = ENV["TP_TEAM_NAME"]
if team_name && !team_name.strip.empty?
  tp_team_lookup = TpToGithub::TargetProcessClient.new(base_url: ENV.fetch("TP_BASE_URL", ""), username: ENV.fetch("TP_USERNAME", ""), password: ENV.fetch("TP_PASSWORD", ""))
  team_id = tp_team_lookup.team_id_by_name(team_name.strip)
else
  raw_id = ENV["TP_TEAM_ID"]
  if raw_id.nil? || raw_id.strip.empty?
    abort "ERROR: You must set either TP_TEAM_NAME or TP_TEAM_ID in the environment."
  end
  team_id = Integer(raw_id, 10)
end
base_url = ENV.fetch("TP_BASE_URL", "")
username = ENV.fetch("TP_USERNAME", "")
password = ENV.fetch("TP_PASSWORD", "")

client = TpToGithub::TargetProcessClient.new(base_url:, username:, password:)
normalizer = TpToGithub::StoryNormalizer.new

stories = client.user_stories(team_id:)
normalized = stories.map { |s| normalizer.normalize(s) }

puts JSON.pretty_generate(normalized)
